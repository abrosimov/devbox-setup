---
# Clean managed .claude directories and files before deployment to ensure
# removed files in the repo are also removed from user's configuration.
# Note: .claude/.claude/settings.local.json is preserved (user permissions)

- name: Clean managed .claude subdirectories before deployment
  ansible.builtin.file:
    path: "{{ devbox_paths.dotfiles_root_dir }}/.claude/{{ item }}"
    state: absent
  loop:
    - agents
    - commands
    - skills
    - schemas
    - bin
    - docs
    - templates
  tags: [configs, claude]

- name: Clean managed .claude root files before deployment
  ansible.builtin.file:
    path: "{{ devbox_paths.dotfiles_root_dir }}/.claude/{{ item }}"
    state: absent
  loop:
    - CLAUDE.md
    - settings.json
    - hooks.json
    - config.md
  tags: [configs, claude]

- name: Collect files and directories from tree
  ansible.builtin.set_fact:
    filetree_items: "{{ lookup('community.general.filetree', 'files/', wantlist=True) }}"
    files_that_should_not_be_overwritten:
      - .config/fish/conf.d/_init_env_confidential.fish

- name: Create layout of home directory
  ansible.builtin.file:
    path: "{{ devbox_paths.dotfiles_root_dir }}/{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
  loop: "{{ filetree_items }}"
  when: item.state == 'directory'

- name: Copy configuration files to appropriate paths.
  ansible.builtin.copy:
    src: "files/{{ item.path }}"
    dest: "{{ devbox_paths.dotfiles_root_dir }}/{{ item.path }}"
    mode: "{{ item.mode | default('0644') }}"
    force: "{{ item.path not in files_that_should_not_be_overwritten }}"
  loop: "{{ filetree_items }}"
  when: item.state == 'file' and not item.path.endswith('.j2')

- name: Render config templates to appropriate paths
  ansible.builtin.template:
    src: "files/{{ item.path }}"
    dest: "{{ devbox_paths.dotfiles_root_dir }}/{{ item.path | regex_replace('\\.j2$', '') }}"
    mode: "{{ item.mode | default('0644') }}"
  loop: "{{ filetree_items }}"
  when: item.state == 'file' and item.path.endswith('.j2')

# Local overlay: laptop-only files not tracked in VCS (from local/ directory).
# Mirrors the same structure as files/ and deploys on top, so local-only
# configs (e.g. fish functions with private paths) stay out of the repo.

- name: Check if local overlay directory exists
  ansible.builtin.stat:
    path: "{{ role_path }}/local"
  register: local_overlay_dir

- name: Collect files from local overlay
  ansible.builtin.set_fact:
    local_filetree_items: "{{ lookup('community.general.filetree', 'local/', wantlist=True) }}"
  when: local_overlay_dir.stat.exists

- name: Create directories from local overlay
  ansible.builtin.file:
    path: "{{ devbox_paths.dotfiles_root_dir }}/{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
  loop: "{{ local_filetree_items }}"
  when: local_overlay_dir.stat.exists and item.state == 'directory'

- name: Copy local overlay files
  ansible.builtin.copy:
    src: "local/{{ item.path }}"
    dest: "{{ devbox_paths.dotfiles_root_dir }}/{{ item.path }}"
    mode: "{{ item.mode | default('0644') }}"
  loop: "{{ local_filetree_items }}"
  when: local_overlay_dir.stat.exists and item.state == 'file' and not item.path.endswith('.j2')

- name: Render local overlay templates
  ansible.builtin.template:
    src: "local/{{ item.path }}"
    dest: "{{ devbox_paths.dotfiles_root_dir }}/{{ item.path | regex_replace('\\.j2$', '') }}"
    mode: "{{ item.mode | default('0644') }}"
  loop: "{{ local_filetree_items }}"
  when: local_overlay_dir.stat.exists and item.state == 'file' and item.path.endswith('.j2')
